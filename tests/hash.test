# -*- tcl -*- tcl.tk//DSL tcltest//EN//2.0
## (c) 2021 Andreas Kupries
# # ## ### ##### ######## ############# #####################
## Ankh testsuite
## - API testing
#
## ak hash HASH (string path channel)

kt check Tcl     8.5
kt check tcltest 2

kt local testing ankh

kt source support/util.tcl

# # ## ### ##### ######## ############# #####################
## Pull in the aggregated results: tsv file, 3 columns, hash'label'digest

set r {}
foreach entry [split [string trim [cat [td]/hash.tsv]] \n] {
    lassign [split [string trim $entry] \t] hash label digest
    dict set r $hash $label r:$entry
}

# # ## ### ##### ######## ############# #####################
##

foreach hash [hashes] {
    # - -- --- ----- -------- ------------- ---------------------

    tcltest::test ankh-${hash}-string-1.0 "ak hash $hash string, wrong#args" -body {
	ak hash $hash string STR X
    } -returnCodes error -result "wrong # args: should be \"ak hash $hash string str\""

    tcltest::test ankh-${hash}-channel-1.0 "ak hash $hash channel, wrong#args" -body {
	ak hash $hash channel CHAN X
    } -returnCodes error -result "wrong # args: should be \"ak hash $hash channel chan\""

    tcltest::test ankh-${hash}-path-1.0 "ak hash $hash path, wrong#args" -body {
	ak hash $hash path PATH X
    } -returnCodes error -result "wrong # args: should be \"ak hash $hash path path\""

    # - -- --- ----- -------- ------------- ---------------------
    # Fixed set of test vectors collected from the various digests.

    foreach {label vector} [vectors] {
	incr k
	if {[dict exists  $r $hash $label]} {
	    set digest [dict get $r $hash $label]
	} else {
	    set digest {}
	}
	set tmp [td]/in.[string map {/ _} $hash].$label
	write $tmp $vector

	# ~ ~~ ~~~ ~~~~~ ~~~~~~~~ ~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~

	tcltest::test ankh-${hash}-string-2.${k}-$label "ak hash $hash string, $label" -body {
	    R $hash $label [ak hash $hash string $vector]
	} -result $digest

	tcltest::test ankh-${hash}-channel-2.${k}-$label "ak hash $hash channel, $label" -setup {
	    set chan [open $tmp rb]
	} -body {
	    R $hash $label [ak hash $hash channel $chan]
	} -cleanup {
	    close $chan
	    unset chan
	} -result $digest

	tcltest::test ankh-${hash}-path-2.${k}-$label "ak hash $hash path, $label" -body {
	    R $hash $label [ak hash $hash path $tmp]
	} -result $digest

	# ~ ~~ ~~~ ~~~~~ ~~~~~~~~ ~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~

	file delete $tmp
    }

    # - -- --- ----- -------- ------------- ---------------------
    unset k
}

# # ## ### ##### ######## ############# #####################
cleanupTests
return
